name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  laravel-ci:
    runs-on: ubuntu-latest

    env:
      COMPOSE_PROJECT_NAME: property-generator
      COMPOSE_PATH_SEPARATOR: ";"
      COMPOSE_FILE: docker/app.yml;docker/database.yml;docker/database_administration.yml;docker/redis.yml
      APP_KEY: ''
      APP_ENV: testing
      DB_CONNECTION: mysql
      DB_HOST: mysql
      DB_PORT: 3306
      DB_DATABASE: property_generator
      DB_USERNAME: root
      DB_PASSWORD: root
      REDIS_HOST: redis
      CACHE_DRIVER: redis
      SESSION_DRIVER: redis
      QUEUE_CONNECTION: redis
      OPENAI_API_KEY: ''

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install Docker Compose
        run: |
          sudo curl -L "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          docker-compose --version

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Create .env for container
        run: |
          if [ ! -f .env ]; then
            if [ -f .env.example ]; then
              cp .env.example .env
            else
              echo "APP_KEY=" > .env
              echo "APP_ENV=testing" >> .env
              echo "DB_CONNECTION=mysql" >> .env
              echo "DB_HOST=mysql" >> .env
              echo "DB_PORT=3306" >> .env
              echo "DB_DATABASE=property_generator" >> .env
              echo "DB_USERNAME=root" >> .env
              echo "DB_PASSWORD=root" >> .env
            fi
          fi
          cat .env

      - name: Start Docker Compose services
        run: docker-compose up -d --build

      - name: Wait for app service to be ready
        run: |
          echo "Waiting for app container to be ready..."
          for i in {1..18}; do
            if docker-compose exec -T app php -v >/dev/null 2>&1; then
              echo "App container is ready."
              exit 0
            fi
            echo "App not ready yet... ($i/18)"
            sleep 5
          done
          echo "App container failed to start after 90s"
          docker-compose ps
          docker-compose logs app
          exit 1

      - name: Prepare Laravel environment
        run: |
          docker-compose exec -T app rm -rf .env || true
          docker-compose exec -T app cp .env.example .env || echo "No .env.example found, using mounted .env"
          docker-compose exec -T app php artisan key:generate --force

      - name: Run PHP Formatting
        run: docker-compose exec -T app composer pint

      - name: Run PHPStan
        run: docker-compose exec -T app composer lint

      - name: Run PHPUnit / PEST tests
        run: docker-compose exec -T app php artisan test

      - name: Shutdown Docker Compose
        run: docker-compose down
